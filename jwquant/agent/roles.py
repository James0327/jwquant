"""
智能体角色定义

四大核心角色：情报官、分析师、交易员、风控员。
每个角色定义职责边界、输入输出、可调用的工具集(Skills)和协作关系。

协作模式：
  情报官 → 分析师 → 交易员 → 风控员（审核） → 交易员（执行）
"""
from dataclasses import dataclass, field
from enum import Enum


class RoleName(Enum):
    """角色名称"""
    INTEL = "intel_officer"       # 情报官
    ANALYST = "analyst"           # 分析师
    TRADER = "trader"             # 交易员
    RISK_CTRL = "risk_controller" # 风控员


@dataclass
class RoleDefinition:
    """角色定义"""
    name: RoleName
    title: str
    description: str
    responsibilities: list[str]
    skills: list[str]
    inputs: list[str]
    outputs: list[str]


# ============================================================
# 情报官 (Intelligence Officer)
# ============================================================
# 类比：投资团队中的研究助理 / 信息收集员
# 核心价值：确保团队在做决策前拥有最全面、最及时的信息
# ============================================================

INTEL_OFFICER = RoleDefinition(
    name=RoleName.INTEL,
    title="情报官",
    description="负责全方位的信息收集与初步加工，是团队的'眼睛和耳朵'。"
    "在每个交易日开盘前和盘中持续工作，为分析师提供决策原材料。",

    responsibilities=[
        # --- 盘前职责 ---
        "采集隔夜重大新闻（国内外财经、政策、突发事件）",
        "收集目标股票的最新公告（业绩预告、股东变动、重大合同）",
        "抓取社区舆情数据（股吧、雪球热帖、讨论趋势）",
        "汇总宏观经济数据（CPI、PMI、社融、利率决议）",
        "整理行业研报摘要和券商晨报要点",

        # --- 盘中职责 ---
        "实时监控财联社等快讯，捕捉突发利好/利空",
        "追踪关键词异动（'资产重组'、'退市风险'、'业绩暴雷'等）",
        "监测市场情绪指标（贪婪/恐慌指数变化）",
        "跟踪北向资金、主力资金流向等异动信号",

        # --- 数据加工 ---
        "对采集的原始信息做去重、分类、标签化处理",
        "利用 NLP 对新闻和舆情做情感评分（正面/中性/负面）",
        "将加工后的情报以结构化格式推送给分析师",
    ],

    skills=[
        "crawler.news",        # 新闻采集
        "crawler.sentiment",   # 舆情采集
        "crawler.report",      # 研报采集
        "nlp.sentiment",       # 情感分析
        "nlp.parser",          # 文档解析
    ],

    inputs=[
        "目标股票池（关注的股票列表）",
        "监控关键词列表",
        "数据源配置（财联社、雪球、东财等）",
    ],

    outputs=[
        "每日情报摘要（结构化 JSON）",
        "实时预警消息（利好/利空/异动）",
        "舆情情感评分报告",
        "宏观/行业数据汇总",
    ],
)


# ============================================================
# 分析师 (Analyst)
# ============================================================
# 类比：投资团队中的策略研究员 / 基金经理助理
# 核心价值：将原始信息和数据转化为可执行的投资观点和交易建议
# ============================================================

ANALYST = RoleDefinition(
    name=RoleName.ANALYST,
    title="分析师",
    description="负责技术分析、基本面分析和量化建模，是团队的'大脑'。"
    "综合情报官提供的信息和行情数据，产出投资观点和交易信号。",

    responsibilities=[
        # --- 技术分析 ---
        "计算目标股票的技术指标（MACD/RSI/ATR/KDJ/布林带）",
        "识别缠论形态（笔/线段/中枢/分型）",
        "判断当前市场所处阶段（趋势/震荡/反转）",
        "基于海龟法则/网格/轮动等策略模型生成交易信号",

        # --- 基本面分析 ---
        "利用 RAG 系统检索财报数据，分析营收/利润/现金流",
        "按研报'五步法'生成个股基本面分析报告",
        "评估目标股票的估值水平（PE/PB/DCF）",

        # --- 量化建模 ---
        "运行因子挖掘模型，产出'上涨概率因子'",
        "执行策略回测，评估策略有效性（夏普/回撤/胜率）",
        "论文复现和策略迭代优化",

        # --- 综合研判 ---
        "融合技术面 + 基本面 + 舆情面，形成综合投资观点",
        "产出每日交易建议（买入/卖出/持有 + 目标价 + 止损价）",
        "撰写投资晨报和研究报告",
    ],

    skills=[
        "indicator.talib",         # 技术指标计算
        "indicator.chanlun",       # 缠论分析
        "indicator.signal",        # 信号生成
        "backtest.engine",         # 回测引擎
        "backtest.stats",          # 绩效分析
        "ml.factor",               # 因子挖掘
        "llm.rag",                 # RAG 投研
        "llm.prompt",              # Prompt 生成
        "research.app.report",     # 研报生成
        "research.app.briefing",   # 晨报生成
    ],

    inputs=[
        "情报官的情报摘要和舆情评分",
        "实时/历史行情数据（K线、Tick）",
        "财报和研报文档（通过 RAG 检索）",
        "策略参数配置",
    ],

    outputs=[
        "交易信号（股票代码、方向、价格、数量、止损、理由）",
        "投资晨报",
        "个股研究报告",
        "策略回测报告",
        "因子评分结果",
    ],
)


# ============================================================
# 交易员 (Trader)
# ============================================================
# 类比：投资团队中的交易执行员
# 核心价值：将分析师的交易建议精准、高效地转化为实际订单
# ============================================================

TRADER = RoleDefinition(
    name=RoleName.TRADER,
    title="交易员",
    description="负责订单的生成、提交和生命周期管理，是团队的'手'。"
    "将分析师产出的交易信号转化为实盘/模拟盘订单，并跟踪执行结果。",

    responsibilities=[
        # --- 订单执行 ---
        "接收分析师的交易信号，转化为标准委托指令",
        "将委托提交至 XtQuant（模拟盘或实盘）",
        "处理异步成交回报（全部成交/部分成交/废单）",
        "执行撤单和改单操作",

        # --- 执行优化 ---
        "根据市场流动性选择合适的下单时机",
        "大单拆分执行，降低市场冲击成本",
        "利用 RL 模型优化挂单价格",
        "监控滑点，评估执行质量",

        # --- 持仓管理 ---
        "实时同步账户持仓和可用资金",
        "跟踪每笔订单的状态变更",
        "计算持仓盈亏和浮动收益",

        # --- 流程闭环 ---
        "在风控员审核通过后执行下单",
        "风控拦截时暂停执行并等待指令",
        "将成交结果推送给风控员和分析师",
        "推送成交通知给用户（微信/钉钉）",
    ],

    skills=[
        "execution.broker",    # 券商接口
        "execution.order",     # 订单管理
        "execution.loop",      # 交易闭环
        "ml.rl",               # RL 执行优化
    ],

    inputs=[
        "分析师的交易信号（代码、方向、价格、数量）",
        "风控员的审核结果（通过/拒绝）",
        "账户当前持仓和资金状态",
    ],

    outputs=[
        "委托回报（订单ID、状态、成交价、成交量）",
        "持仓变更通知",
        "执行质量报告（滑点、成交率）",
        "成交通知消息",
    ],
)


# ============================================================
# 风控员 (Risk Controller)
# ============================================================
# 类比：投资团队中的合规风控经理
# 核心价值：守护资金安全，在交易执行前拦截不合规的操作
# ============================================================

RISK_CTRL = RoleDefinition(
    name=RoleName.RISK_CTRL,
    title="风控员",
    description="负责交易前审核和盘中风险监控，是团队的'安全阀'。"
    "对每一笔交易指令进行风控检查，对持仓和账户进行实时风险监控。",

    responsibilities=[
        # --- 盘前风控 ---
        "检查当日交易计划的合规性",
        "验证目标股票是否在黑名单中（ST/*ST/退市风险）",
        "核算计划交易量是否超出资金上限",
        "评估交易计划的整体风险敞口",

        # --- 逐笔审核（交易员下单前） ---
        "检查单笔委托金额是否超限",
        "检查单票仓位是否超过总资产占比上限",
        "检查同一股票短时间内是否重复下单（频率限制）",
        "检查买入标的是否处于涨停/跌停状态",
        "审核通过则放行，不通过则拦截并记录原因",

        # --- 盘中实时监控 ---
        "监控当日累计亏损，触及单日最大回撤时启动熔断",
        "监控持仓集中度，避免单一标的过度集中",
        "检测异常交易行为（短时间内频繁买卖同一股票）",
        "监控账户总资产变化，异常波动时发出预警",

        # --- 熔断与应急 ---
        "触发熔断时，冻结所有新委托",
        "紧急情况下强制发出全部持仓的清仓指令",
        "记录所有风控事件和拦截日志，供复盘分析",

        # --- 盘后复盘 ---
        "统计当日风控触发次数和拦截详情",
        "评估当日交易的风险指标（VaR、最大回撤）",
        "生成每日风控报告",
    ],

    skills=[
        "risk.rules",          # 风控规则引擎
        "risk.interceptor",    # 拦截器
        "backtest.attribution", # 归因分析（复盘用）
    ],

    inputs=[
        "交易员提交的委托指令（审核请求）",
        "当前账户资产和持仓信息",
        "风控规则配置（资金上限/仓位限制/黑名单等）",
        "实时行情数据（用于涨跌停检测）",
    ],

    outputs=[
        "审核结果（通过/拒绝 + 原因）",
        "风控预警消息",
        "熔断指令",
        "每日风控报告",
    ],
)


# ============================================================
# 角色注册表
# ============================================================

ALL_ROLES: dict[RoleName, RoleDefinition] = {
    RoleName.INTEL: INTEL_OFFICER,
    RoleName.ANALYST: ANALYST,
    RoleName.TRADER: TRADER,
    RoleName.RISK_CTRL: RISK_CTRL,
}


def get_role(name: RoleName) -> RoleDefinition:
    """获取角色定义"""
    return ALL_ROLES[name]


# ============================================================
# 协作流程定义
# ============================================================
#
# 1. 投资晨会工作流 (盘前 08:30)
#    情报官 → 分析师 → 交易员 → 风控员
#    ┌──────────┐    ┌──────────┐    ┌──────────┐    ┌──────────┐
#    │  情报官   │───▶│  分析师   │───▶│  交易员   │───▶│  风控员   │
#    │          │    │          │    │          │    │          │
#    │ 采集隔夜  │    │ 技术+基本 │    │ 制定交易  │    │ 审核计划  │
#    │ 新闻舆情  │    │ 面综合研判│    │ 执行计划  │    │ 评估风险  │
#    └──────────┘    └──────────┘    └──────────┘    └──────────┘
#         输出:             输出:           输出:          输出:
#      情报摘要         投资晨报         交易计划       审核意见
#
#
# 2. 盘中交易工作流 (09:30-15:00)
#    ┌──────────┐    ┌──────────┐    ┌──────────┐    ┌──────────┐
#    │  情报官   │    │  分析师   │───▶│  交易员   │───▶│  风控员   │
#    │          │    │          │    │          │    │          │
#    │ 实时监控  │───▶│ 生成信号  │    │ 提交委托  │◀───│ 审核/放行 │
#    │ 突发预警  │    │ 调整观点  │    │ 跟踪执行  │    │ 实时监控  │
#    └──────────┘    └──────────┘    └──────────┘    └──────────┘
#                                         │               │
#                                         │   ◀──拦截──    │
#                                         │               │
#                                         ▼               ▼
#                                    成交通知         风控预警
#
#
# 3. 盘后复盘工作流 (15:30)
#    ┌──────────┐    ┌──────────┐    ┌──────────┐
#    │  交易员   │───▶│  风控员   │───▶│  分析师   │
#    │          │    │          │    │          │
#    │ 提交交割单│    │ 风控报告  │    │ 归因分析  │
#    │ 执行报告  │    │ 风险评估  │    │ 策略优化  │
#    └──────────┘    └──────────┘    └──────────┘
#
