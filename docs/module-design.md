# JWQuant 模块详细设计

本文档对 17 个模块的子模块、功能职责、核心接口进行详细描述。

---

## 1. 数据模块 (data)

负责行情数据的获取、清洗和本地持久化，为策略和智能体提供统一的数据访问接口。

### 子模块

| 子模块 | 文件 | 功能描述 |
|--------|------|---------|
| 行情数据 | `market_data.py` | 支持 Tushare、Baostock、YFinance、XtQuant 四种数据源，获取实时/历史 K 线、Tick 数据 |
| 数据清洗 | `data_cleaner.py` | 处理停牌数据、除权除息（前复权/后复权）、缺失值填充、异常值检测 |
| 数据存储 | `data_store.py` | 本地高质量行情数据库，支持 CSV、HDF5、SQLite 三种存储格式 |
| 数据馈送 | `data_feed.py` | 统一数据接口，向策略层和回测引擎提供标准化的 DataFrame 格式数据 |

### 数据源对比

| 数据源 | 特点 | 适用场景 |
|--------|------|---------|
| Tushare | 数据全面，需 Token | A 股日线/分钟线/财务数据 |
| Baostock | 免费，无需注册 | A 股历史日线/周线 |
| YFinance | 全球市场 | 美股/港股/ETF |
| XtQuant | 实时行情，券商级 | 实盘交易时的实时数据 |

---

## 2. 技术指标模块 (indicators)

封装常用技术分析指标，支持自定义指标扩展，将指标计算结果转化为交易信号。

### 子模块

| 子模块 | 文件 | 功能描述 |
|--------|------|---------|
| Talib 封装 | `talib_wrapper.py` | 封装 TA-Lib 库：SMA、EMA、MACD、RSI、ATR、KDJ、布林带等常用指标 |
| 自定义指标 | `custom_indicators.py` | 缠论指标（笔/线段/中枢）、唐奇安通道、自定义组合指标 |
| 信号生成 | `signal_generator.py` | 根据指标计算结果生成标准化的买入/卖出/持有信号 |

### 支持的指标列表

- **趋势类**: SMA, EMA, MACD, 唐奇安通道
- **震荡类**: RSI, KDJ, 布林带, CCI
- **波动率**: ATR, 标准差
- **成交量**: OBV, 量比
- **缠论**: 分型, 笔, 线段, 中枢

---

## 3. 策略模块 (strategy)

实现经典量化交易策略，提供策略基类和注册管理机制，支持多策略并行运行。

### 子模块

| 子模块 | 文件 | 功能描述 |
|--------|------|---------|
| 策略基类 | `base_strategy.py` | 定义策略生命周期方法：`on_init()`, `on_bar()`, `on_tick()`, `on_order()`, `on_trade()` |
| 海龟策略 | `turtle_strategy.py` | 海龟交易法则：唐奇安通道突破入场，ATR 动态止损与加仓，科学仓位管理 |
| 缠论策略 | `chanlun_strategy.py` | 缠论量化：笔/线段/中枢数学定义与算法识别，底分型与第三类买点信号输出 |
| 网格策略 | `grid_strategy.py` | 网格交易法：均值回归逻辑，自动在价格网格内低买高卖 |
| 轮动策略 | `rotation_strategy.py` | 动量轮动：强者恒强的市场规律，小市值轮动选股 |
| 策略注册 | `strategy_registry.py` | 策略统一注册、发现与管理，支持多策略同时运行 |

### 策略生命周期

```
on_init()      → 策略初始化，加载参数和指标
    │
on_bar(bar)    → 每根 K 线触发，执行策略逻辑
    │
on_tick(tick)  → 每个 Tick 触发（高频策略）
    │
on_order(order)→ 委托状态变更回调
    │
on_trade(trade)→ 成交回报回调
```

---

## 4. 机器学习模块 (ml)

将机器学习和强化学习技术应用于因子挖掘、策略进化和交易执行优化。

### 子模块

| 子模块 | 文件 | 功能描述 |
|--------|------|---------|
| 因子挖掘 | `factor_mining.py` | 将 Talib 技术指标作为特征(Feature)，次日涨跌作为标签(Label)，训练二分类预测模型，产出"上涨概率因子" |
| 论文复现 | `paper_replicator.py` | AI 辅助复现量化论文：提取数学公式与逻辑框架 → 翻译为 Backtrader 策略代码 |
| 策略进化 | `strategy_evolver.py` | 设置目标函数（如夏普比率>1.5），AI 自动修改代码参数与逻辑，多轮"优胜劣汰"迭代 |
| 强化学习 | `rl_trader.py` | RL 模型优化挂单价格，实现智能拆单与择时 |
| Qlib 集成 | `qlib_integration.py` | 集成微软 Qlib 量化研究框架，利用其工具箱和预置模型 |

### 因子挖掘流程

```
原始数据 → 特征工程(Talib指标) → 标签生成(次日涨跌) → 模型训练(XGBoost/LightGBM)
    → 产出"上涨概率因子" → 辅助策略买卖点判断
```

### 策略进化流程

```
初始策略代码 → 回测(Backtrader) → 评估(夏普/回撤) → AI分析不足
    → AI修改参数/逻辑 → 再次回测 → 循环迭代至达标
```

---

## 5. 回测模块 (backtest)

提供策略历史验证能力，集成 QuantStats 绩效分析，支持归因分析帮助区分运气与策略收益。

### 子模块

| 子模块 | 文件 | 功能描述 |
|--------|------|---------|
| 回测引擎 | `backtrader_engine.py` | 封装 Backtrader 框架：数据投喂、策略加载、撮合模拟、结果输出 |
| 绩效分析 | `performance.py` | 集成 QuantStats：年化收益率、夏普比率、最大回撤、胜率、Sortino 比率等 |
| 回测报告 | `report.py` | 生成回测报告：交易明细、净值曲线、基准对比图、月度收益热力图 |
| 归因分析 | `attribution.py` | 交割单归因：区分运气vs策略收益，识别盈利来源，优化策略参数 |

### 核心绩效指标

| 指标 | 说明 |
|------|------|
| 年化收益率 | 策略的年化回报 |
| 夏普比率 | 风险调整后收益（目标>1.5） |
| 最大回撤 | 最大净值回撤幅度 |
| 胜率 | 盈利交易占比 |
| 盈亏比 | 平均盈利/平均亏损 |
| Sortino 比率 | 仅考虑下行风险的夏普比率 |

---

## 6. 交易执行模块 (execution)

对接实盘接口，管理订单全生命周期，实现从信号到下单的自动化交易闭环。

### 子模块

| 子模块 | 文件 | 功能描述 |
|--------|------|---------|
| 券商接口 | `broker.py` | 券商接口抽象层，封装 XtQuant SDK，支持连接/断开/重连 |
| 订单管理 | `order_manager.py` | 委托管理：下单/撤单/改单，同步报单，处理异步回调，订单状态跟踪 |
| 交易路由 | `trade_router.py` | 将策略信号转化为实际委托指令，支持模拟盘/实盘切换 |
| 持仓管理 | `position_manager.py` | 实时持仓同步、持仓变更跟踪、盈亏计算 |
| 交易闭环 | `trade_loop.py` | 自动化交易闭环：信号触发 → 风控审核 → 下单执行 → 消息推送 |

### 自动化交易闭环流程

```
策略信号触发
    │
    ▼
风控审核 ──── 不通过 → 记录日志 + 通知
    │
    ▼ 通过
生成委托指令
    │
    ▼
提交至 XtQuant（模拟盘/实盘）
    │
    ▼
监听异步回调（成交/撤单/废单）
    │
    ▼
更新持仓 + 推送消息通知
```

---

## 7. 风控模块 (risk)

为交易安全保驾护航，支持盘前风控检查和盘中实时监控，可配置风控规则。

### 子模块

| 子模块 | 文件 | 功能描述 |
|--------|------|---------|
| 盘前风控 | `pre_trade_check.py` | 资金上限检查、单票仓位限制、黑名单过滤、涨跌停限制 |
| 盘中监控 | `realtime_monitor.py` | 单日最大回撤、异常波动检测、持仓集中度监控 |
| 拦截逻辑 | `interceptor.py` | 风控规则不通过时阻断下单，记录拦截原因 |
| 规则引擎 | `risk_rules.py` | 可配置的规则链：熔断机制、频率限制、自定义规则扩展 |

### 风控规则

| 规则类型 | 示例 |
|----------|------|
| 资金上限 | 单笔下单金额不超过总资产的 X% |
| 仓位限制 | 单只股票持仓不超过总资产的 Y% |
| 黑名单 | 禁止交易 ST/*ST/退市风险股 |
| 最大回撤 | 当日亏损达 Z% 时触发熔断，停止交易 |
| 频率限制 | 同一股票 N 分钟内不得重复下单 |

---

## 8. 账户模块 (account)

管理券商账户连接，提供资产和持仓查询能力，支持多账户并行管理。

### 子模块

| 子模块 | 文件 | 功能描述 |
|--------|------|---------|
| 连接管理 | `account_manager.py` | QMT/XtQuant 连接、登录、断线重连、退出，包含重试机制 |
| 资产查询 | `asset_query.py` | 查询可用资金、冻结资金、持仓市值、总资产 |
| 多账户 | `multi_account.py` | 多账户统一管理，资金分配策略，账户间隔离 |

---

## 9. MCP 协议与 Skill 模块 (mcp_skill)

将系统能力封装为标准化的工具(Skill)，通过 MCP 协议让大模型调用量化交易系统的各项功能。

### 子模块

| 子模块 | 文件 | 功能描述 |
|--------|------|---------|
| Skill 注册 | `skill_registry.py` | Skill 定义与注册中心：将数据能力、计算能力、交易能力封装为标准工具 |
| MCP 服务 | `mcp_server.py` | MCP 协议服务端：接收大模型的工具调用请求，路由至对应 Skill 执行 |
| 工具封装 | `tool_wrapper.py` | 将回测、下单、查询、指标计算等功能包装为 Function Call 兼容的工具格式 |

### Skill 示例

| Skill 名称 | 功能 | 输入 | 输出 |
|------------|------|------|------|
| `query_stock_data` | 查询股票行情 | 股票代码, 时间范围 | K 线 DataFrame |
| `run_backtest` | 执行回测 | 策略名, 参数, 时间范围 | 绩效指标 |
| `place_order` | 下单 | 股票代码, 方向, 数量, 价格 | 订单状态 |
| `calc_indicator` | 计算指标 | 股票代码, 指标名, 参数 | 指标值序列 |
| `analyze_sentiment` | 舆情分析 | 关键词 | 情感评分 |

---

## 10. 大模型层 (llm)

提供大模型统一接口、RAG 检索增强生成、Prompt 工程和 Function Call 能力。

### 子模块

| 子模块 | 文件 | 功能描述 |
|--------|------|---------|
| LLM 接口 | `llm_client.py` | 大模型统一接口，支持 OpenAI、通义千问、本地部署模型的切换 |
| Prompt 引擎 | `prompt_engine.py` | Prompt 模板管理：研报生成/绩效分析/晨报撰写/舆情总结等场景模板 |
| RAG 引擎 | `rag_engine.py` | 检索增强生成：向量数据库检索相关文档 → 上下文注入 → LLM 生成回答 |
| Function Call | `function_call.py` | 让大模型调用量化系统的工具函数（与 MCP Skill 对接） |

### RAG 投研系统架构

```
用户提问（如"分析贵州茅台基本面"）
    │
    ▼
向量检索：从财报/研报向量库中检索相关文档片段
    │
    ▼
上下文构建：将检索结果 + 用户提问组合为 Prompt
    │
    ▼
LLM 生成：大模型基于上下文生成专业分析报告
```

---

## 11. 智能体编排模块 (agent)

基于 LangGraph 实现多智能体协作的工作流编排，是系统的"大脑"。

### 子模块

| 子模块 | 文件 | 功能描述 |
|--------|------|---------|
| 角色定义 | `agent_roles.py` | 定义四大角色：情报官、分析师、交易员、风控员，各自的职责和可调用的工具 |
| LangGraph 引擎 | `langgraph_engine.py` | LangGraph 工作流核心：定义 Node(员工)、Edge(流程)、State(状态) |
| 工作流模板 | `workflow.py` | 预置工作流：投资晨会、交易决策、风险预警、绩效复盘 |
| 协调器 | `orchestrator.py` | 多智能体协调：角色调度、消息传递、结果汇总、异常处理 |

### 角色职责

| 角色 | 职责 | 调用的模块 |
|------|------|-----------|
| 情报官 | 收集市场信息、监控舆情、追踪新闻热点 | crawler, nlp, sentiment_monitor |
| 分析师 | 技术分析、基本面分析、生成研报、因子挖掘 | indicators, ml, report_generator |
| 交易员 | 执行交易策略、管理订单、跟踪持仓 | strategy, execution, trade_loop |
| 风控员 | 审核交易指令、监控风险指标、执行熔断 | risk, interceptor, realtime_monitor |

### 投资晨会工作流

```
情报官：采集隔夜新闻 + 舆情分析 + 市场情绪评估
    │
    ▼
分析师：结合行情数据 + 技术指标 + 基本面，产出分析观点
    │
    ▼
交易员：根据分析结果，制定当日交易计划
    │
    ▼
风控员：审核交易计划，评估风险敞口
    │
    ▼
输出：每日投资晨报
```

---

## 12. 外部数据采集模块 (crawler)

采集新闻、舆情、研报等非行情类外部数据。

### 子模块

| 子模块 | 文件 | 功能描述 |
|--------|------|---------|
| 新闻采集 | `news_crawler.py` | 对接新闻接口（财联社等），采集财经新闻、公告、政策信息 |
| 舆情采集 | `sentiment_crawler.py` | 采集股吧、雪球、东财社区等平台的股票讨论和舆情数据 |
| 研报采集 | `report_crawler.py` | 采集券商研报、财报 PDF 文档 |

---

## 13. NLP 数据处理模块 (nlp)

对非结构化文本进行解析、向量化和语义分析，为 RAG 和舆情监控提供数据基础。

### 子模块

| 子模块 | 文件 | 功能描述 |
|--------|------|---------|
| PDF 解析 | `pdf_parser.py` | PDF/Word 文档解析，提取结构化文本与表格数据 |
| 文本向量化 | `text_vectorizer.py` | 文本 Embedding，将文档转为向量表示，支持多种 Embedding 模型 |
| 向量数据库 | `vector_store.py` | 向量数据库管理（FAISS/Chroma），文档向量的存储、索引与检索 |
| 情感分析 | `sentiment_analyzer.py` | NLP 情绪分析：贪婪/恐慌指数、关键词（"资产重组"等）捕捉与量化打分 |

---

## 14. AI 应用层 (ai_app)

面向用户的智能应用，将 LLM 能力与量化数据结合，产出实用的投研工具。

### 子模块

| 子模块 | 文件 | 功能描述 |
|--------|------|---------|
| 智能研报 | `report_generator.py` | 基于国泰君安研报"五步法"，结合 RAG 数据生成基本面分析报告 |
| 投资晨会 | `morning_briefing.py` | 每日自动生成投资晨报：隔夜新闻、市场情绪、技术面分析、交易计划 |
| 舆情监控 | `sentiment_monitor.py` | 实时舆情监控系统：关键词追踪、情绪异动预警、利好/利空推送 |
| 绩效报告 | `performance_reporter.py` | 智能体自动撰写绩效分析报告，整合 QuantStats 数据 |

### 研报"五步法"

1. **行业分析** — 行业景气度、政策环境、竞争格局
2. **公司分析** — 商业模式、核心竞争力、管理层
3. **财务分析** — 营收/利润/现金流、ROE、资产负债率
4. **估值分析** — PE/PB/DCF 估值、与同行对比
5. **投资建议** — 目标价、评级、风险提示

---

## 15. 可视化控制台 (dashboard)

基于 Streamlit 构建 Web UI 看板，将智能体工作状态和交易数据可视化展示。

### 子模块

| 子模块 | 文件 | 功能描述 |
|--------|------|---------|
| 主框架 | `streamlit_app.py` | Streamlit 应用入口，页面路由与布局 |
| 智能体看板 | `agent_monitor.py` | 展示各智能体角色的运行状态、决策过程、消息流 |
| 交易看板 | `trade_dashboard.py` | 持仓分布、盈亏曲线、订单状态、成交记录 |
| 策略看板 | `strategy_dashboard.py` | 回测结果、绩效曲线、信号标记、策略对比 |

---

## 16. 调度模块 (scheduler)

管理系统的定时任务和事件驱动机制，确保各模块按时序协调工作。

### 子模块

| 子模块 | 文件 | 功能描述 |
|--------|------|---------|
| 定时任务 | `task_scheduler.py` | 盘前(数据更新/晨报生成)、盘中(策略执行/监控)、盘后(清算/复盘) |
| 事件总线 | `event_bus.py` | 模块间解耦通信：行情事件、信号事件、成交事件、风控事件 |
| 复盘调度 | `evolution_scheduler.py` | 定期触发绩效复盘、归因分析和策略参数自动调优 |

### 每日任务时间线

```
08:30  盘前准备：数据更新、晨报生成、风控规则加载
09:15  开盘就绪：策略初始化、账户同步
09:30  盘中运行：策略执行、信号监控、风控实时检查
11:30  午间休市：中场复盘、舆情更新
13:00  午后开盘：继续策略执行
15:00  收盘处理：持仓同步、盈亏计算
15:30  盘后分析：绩效统计、归因分析、交易日报生成
20:00  晚间任务：隔夜新闻监控、次日策略预调整
```

---

## 17. 基础设施 (infra)

提供配置管理、日志记录和消息通知等基础能力，支撑整个系统运行。

### 子模块

| 子模块 | 文件 | 功能描述 |
|--------|------|---------|
| 配置管理 | `config.py` | 统一配置：券商连接参数、策略参数、风控阈值、LLM API Key、数据源 Token |
| 结构化日志 | `logger.py` | 分级日志：交易日志(成交/撤单)、策略日志(信号/持仓)、智能体日志(决策过程)、系统日志 |
| 消息通知 | `notifier.py` | 多渠道推送：成交通知、风控预警、晨报推送、系统异常报警，支持微信/钉钉/邮件 |
